# 概要
このフォルダには、ACfAのオンラインにおけるロックバグ修正パッチが含まれています。パッチは以下の要素を修正します。
+ 右武器ロックバグの修正
2p→3pのような、プレイヤーナンバーの大きな機体を攻撃する際に発生する命中率低下を修正します。
+ 左武器ロックバグの修正
3p→2pのような、プレイヤーナンバーの小さな機体を攻撃する際に発生するノーロック問題を修正します。
+ 片手ロックバグの修正
片手のみに武器を所持した状態で射撃した際の命中率低下を修正します。

これらの修正により、射撃武器の振る舞いはオフラインと全く同じ状態になります。
このパッチは、BLJM60066、BLJM55005、BLUS30187に対応しています。

## 仕様
敵機体の読み込み関数をフックし、敵機体を示すポインタを静的なメモリ領域に保存します。静的メモリ領域はリングバッファで制御されます。
ポインタの書き込みとリセットを正しく行うことにより、正常なポインタの読み取りを実現します。元々の読み取り領域は維持され、バックアップとして使用されます。

### フックポイント
* 0x933060 / 0x93307c
  * これらのフックポイントは、現在どのような捕捉状態であるかを判定します。0xffが取得される場合、片手かつ射撃中であることを意味します。
* 0x933410 / 0x9334a8
  * 捕捉中の敵機体のポインタを静的メモリに保存します。これは一時的なもので、後でリングバッファに保存されます。
* 0x9794ec
  * リングバッファに情報を保存します。リングバッファには保存先のアドレスと、機体ポインタがセットで保存されます。
  * まず、リングバッファに一致する保存先があるかを探索します。存在した場合は、敵機体のポインタを上書きします。存在しない場合は、新しい領域を確保して保存します。
  * リングバッファは8ペアの情報を保存できます。これにより、パッチは複数人プレイにも対応します。
  * 例外的に、フラグが0xffのときはポインタの更新を行いません。フラグが0xffのときはポインタの値が0になってしまうためです。そのため、更新を行わないことによりポインタを保持します。それにより、読み込み関数は直前のポインタを利用します。
* 0x975084 / 0x97514c
  * 敵機体ポインタの読み込み関数です。読み込み元をリングバッファに変更することで安定したポインタ確保を行います。万一リングバッファが見つからない場合は、元々の処理を実行します。
* 0x979b00
  * フラグ情報をリセットします。

### パッチの技術的内容
このパッチではトランポリン関数を利用しています。まず、元の命令からb命令で、トランポリン関数へジャンプします。
まず、トランポリン関数内でstduを利用しスタックを確保します。そして、スタックにリンクレジスタ(LR)の退避を行います。念のためr0レジスタの退避も行います。
その後、bl命令で本体のパッチコードへとジャンプします。これにより、本体のパッチコードをよりデバッグ可能、かつ再利用できる形で記述できます。
本体のパッチコードの実行が終わると、トランポリンに戻り、リンクレジスタとr0の復元を行います。その上でオリジナルの命令を実行します。

### ファイル内容
* imported_patch.yml
  * パッチファイル本体です。patchesフォルダに配置することで使用可能になります。
* Lockpatch_[region].asm
  * アセンブリファイルです。これをビルドすることでパッチファイルを生成しています。
* imported_patch_old.yml
  * これは古いパッチファイルです。確率された、なおかつ安定した挙動を実現しています。しかし、片手のみの状態での命中率低下を防ぐことはできません。
