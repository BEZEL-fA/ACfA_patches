# 概要
このフォルダには、ACfAのオンライン対戦におけるロックバグ修正パッチが含まれています。このフォルダのパッチは、格納ミサイルに関するものです。
+ 格納ミサイルが追尾しない問題の修正
タンク脚部の格納にハンドミサイルを搭載すると、正常にミサイルが発射できないという問題があります。この問題を修正し、格納ミサイルも正常に追尾できるようにします。
このパッチは攻撃者のサイドで効果を発揮します。つまり、パッチを導入したプレイヤーが恩恵を受けます。
このパッチはBLJM60066、BLJM55005、BLUS30187に対応しています。

## ファイル内容
* imported_patch.yml
  * パッチファイル本体です。patchesフォルダに配置することで使用可能になります。
* FixMissileLock_[region].asm
  * アセンブリファイルです。これをビルドすることでパッチファイルを生成しています。

## 仕様
ミサイルは通常の武器よりも複雑な処理を行う必要があり、それを担う関数が存在します。しかしこの関数はエラーチェックが厳格すぎる、もしくは順序に問題があることにより、格納ミサイルが追加の処理を行えず弾かれてしまっています。
オフラインにおいてもこの問題自体は発生していますが、問題は顕在化していません。しかしオンライン対戦においては、この関数の処理を参照してミサイルのターゲット処理を行うため、問題が顕在化します。
この関数では、エラーチェックの漏れを修正することにより、ミサイルの追尾を正常に行わせます。武器のタイプがミサイルになっているときのみ処理を変更し、関数を正常に実行します。
関数はCode Caveに配置されます。

## フックポイント
フックポイントのアドレスはBLJM60066を基準として示されます。
* 0x7b406c
 * エラーチェック関数の戻り値を判定するポイントです。0であれば関数を終了し、ミサイルの処理を行いません。1であればミサイルと判定され、ミサイル特有の処理にジャンプします。

## パッチの技術的内容
このパッチでは、crレジスタを調節することによってジャンプを制御します。格納ミサイルが発射されたときのみ、cr7のEQビットを0にします。
r31レジスタには武器の同時発射数が格納されており、このアドレスを-0x4すると武器の構造体のポインタを見つけることができるため、これを利用します。
このポインタのアドレスから-0x2cした場所のビットが武器の種別フラグになっています。0が通常武器、1がミサイル、2がキャノン系です。
このフラグが1になっていたときのみcr7のEQビットを0にすることにより、正常な処理へジャンプすることができます。
